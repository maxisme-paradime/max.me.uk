+++
banner = ""
content = "# Intro\n\nThere are two different places a 404 page is likely to come up when using Traefik.\n\nThe first one is when Traefik does not know where to forward your request because you haven't set up a router for a route (e.g. pointing a random domain to your Traefik IP address with no corresponding router rule).\n\nThe second is when a service on Traefik returns a 404 (e.g. an NGINX service).\n\n# Setup\n\n## Golang\n\nFirst I wrote a basic server that returns a static 404 page located at `./static/404.html`\n\n_./main.go_\n\n    package main\n    \n    import (\n    \t\"io/ioutil\"\n    \t\"log\"\n    \t\"net/http\"\n    \t\"os\"\n    \t\"path/filepath\"\n    )\n    \n    func main() {\n    \tcurrentDir, _ := filepath.Abs(filepath.Dir(os.Args[0]))\n    \tfile, _ := ioutil.ReadFile(currentDir + \"/static/404.html\")\n        \n    \thttp.HandleFunc(\"/\", func(w http.ResponseWriter, r *http.Request) {\n    \t\tw.Header().Set(\"Content-Type\", \"text/html; charset=utf-8\")\n    \t\tw.WriteHeader(http.StatusNotFound)\n    \t\t_, _ = w.Write(file)\n    \t})\n    \tlog.Fatal(http.ListenAndServe(\":8080\", nil))\n    }\n\n## Docker\n\nI then wrote a Dockerfile to containerise my Go application and uploaded it to Docker Hub - [maxisme/404](https://hub.docker.com/repository/docker/maxisme/max.me.uk).\n\n_Dockerfile_\n\n    FROM golang:alpine AS builder\n    ADD . /app/\n    WORKDIR /app\n    RUN go build -o app\n    \n    FROM alpine\n    COPY --from=builder /app /app\n    CMD [\"/app/app\"]\n\n## Traefik\n\nThen in my swarm, I created the **404** Traefik service using `labels`:\n\n_stack.yml_\n\n      missing:\n        image: maxisme/404:latest\n        deploy:\n          mode: global\n          labels:\n            - \"traefik.enable=true\"\n            - \"traefik.http.routers.404.rule=HostRegexp(`{catchall:.*}`)\"\n            - \"traefik.http.routers.404.priority=1\"\n            - \"traefik.http.routers.404.entrypoints=web-secure\"\n            - \"traefik.http.routers.404.tls.certresolver=letsencrypt\"\n            - \"traefik.http.services.404.loadbalancer.server.port=8080\"\n        networks:\n          - traefik\n\nThe labels:\n\n    - \"traefik.http.routers.404.rule=HostRegexp(`{catchall:.*}`)\"\n    - \"traefik.http.routers.404.priority=1\"\n\napply the 404 service by default to every route at the lowest priority (to fix the first case - _\"when Traefik does not know where to forward your request\"_).\n\nIn Traefik I also created the 404 [error middleware](https://docs.traefik.io/middlewares/errorpages/) using these labels:\n\n    - \"traefik.http.middlewares.404.errors.status=404\"\n    - \"traefik.http.middlewares.404.errors.service=404\"\n    - \"traefik.http.middlewares.404.errors.query=/404.html\"\n\nThis catches any 404 errors returned by a service and routes it to our custom **404** service (solving the second case).\n\nFinally, you then should add the middleware to your services by adding the label:\n\n    - \"traefik.http.routers.YOURSERVICE.middlewares=404\""
date = 2020-06-25T00:00:00Z
meta_description = "Setting up a custom 404 page in Traefik."
tags = ["Traefik", "404", "Docker", "Swarm"]
title = "Custom 404 Page in Traefik"

+++
