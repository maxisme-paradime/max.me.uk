+++
banner = ""
content = "Thanks to a mix of [this](https://kirb.me/2018/03/24/using-samba-as-a-time-machine-network-server.html#fnref:bzaffiliate) article and the [dperson/samba](https://github.com/dperson/samba) Docker container this was actually really straight forward to setup.\n\nAs usual, you can skip any of my chat and just look at the code - [maxisme/docker-time-machine](https://m4x.uk/docker-time-machine).\n\n## Samba Setup\n\nFirst of all, you need to write a samba config to set up a specific time machine folder in the container at `/mnt/data/time-machine`. More details explained [here](https://wiki.samba.org/index.php/Configure_Samba_to_Work_Better_with_Mac_OS_X).\n\n_samba.conf_\n\n    [timemachine]\n        comment = Time Machine\n        path = /mnt/data/time-machine\n        browseable = yes\n        writeable = yes\n        create mask = 0600\n        directory mask = 0700\n        spotlight = yes\n        vfs objects = catia fruit streams_xattr\n        fruit:aapl = yes\n        fruit:time machine = yes\n\nAfter that you can create your samba container:\n\n_docker-compose.yml_\n\n    version: '3.3'\n    services:\n      samba:\n        container_name: samba\n        restart: always\n        ports:\n          - '139:139'\n          - '445:445'\n        volumes:\n          - './samba.conf:/samba.conf'\n          - '${MNT:?err}:/mnt/time-machine/'\n        command: \"-p -I /samba.conf -u \\\"${USER:?err};${PASS:?err}\\\" -s \\\"samba;/mnt/time-machine/;yes;no;no;$USER\\\"\"\n        image: dperson/samba\n\nI like to put environment variables in my docker-compose files so that I can hide the values when publishing to GitHub. But feel free to hardcode the `${...}` values and then you can simply run `$ docker-compose up -d` and skip to the next section.\n\nIf you choose to keep the environment variables you can then create two more files:\n\nThe first to put your variables; `MNT` which is used to point to where the time machine backups should be stored on your machine running Docker. And `USER` and `PASS` for the passwords for the server.\n\n_.env_\n\n    MNT=\n    USER=\n    PASS=\n\nFinally, you can then add a shell file to run the docker-compose with the variables:\n\n_run.sh_\n\n    #!/bin/bash\n    export $(grep -v '^#' .env | xargs)\n    docker-compose up -d\n\n## Time Machine Setup\n\nNow on your Mac go to **Finder** and press `cmd+k`:\n\n![](/uploads/screenshot-2020-07-11-at-15-03-02.png)\n\nhere you should enter the address of your time machine server like `smb://192.168.0.108` where `192.168.0.108` is the address of my machine running my samba docker container. Any problems here please check the usual:\n\n* `$ docker logs samba`\n* Firewall -  Do you have UFW enabled? If so allow ports `139` and `445`.\n\nAfter pressing connect it will then ask for the username and password set in the `.env`\n\n![](/uploads/screenshot-2020-07-11-at-15-10-40.png)\n\nAnd which volume\n\n![](/uploads/screenshot-2020-07-11-at-15-11-03.png)\n\nYou will then have the time machine volume mounted on your mac. Now visit `System Preferences > Time Machine` and select the `timemachine` disk.\n\n![](/uploads/screenshot-2020-07-11-at-15-16-07.png)\n\nðŸŽ‰ You now have time machine set up!\n\n***\n\nAlso to speed up the time machine a bit you can run on your mac:\n\n    $ sudo sysctl debug.lowpri_throttle_enabled=0"
date = 2020-07-11T00:00:00Z
draft = true
meta_description = "Deploying a time machine server with Docker."
tags = ["docker", "time machine", "samba", "macos"]
title = "Time Machine in a Docker container"

+++
